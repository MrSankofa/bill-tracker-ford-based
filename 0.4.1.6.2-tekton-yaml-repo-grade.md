### 0.4.1.6.2 Commit Tekton manifests to your YAML repo

What is a manifest in this context?
A manifest is a YAML file that defines the configuration and behavior of Tekton resources such as Pipelines, Tasks, and PipelineRuns. These manifests are essential for deploying and managing your CI/CD workflows in a Kubernetes environment.

Why commit Tekton manifests to your YAML repo?
Committing Tekton manifests to your YAML repository ensures that your CI/CD configurations are version-controlled, easily accessible, and can be deployed consistently across different environments. It also facilitates collaboration among team members and helps maintain a history of changes made to the CI/CD setup.

If CI config isn't in source control, it's folklore. Folklore breaks the moment you 
switch laptops, or teammates. We want this to be repeatable and reviewable.

### Step 1: Create a Tekton Folder Structure
from the repo root (bill-tracker-ford-based), create:

```bash
mkdir -p tekton/pipelineruns
mkdir -p tekton/resources
```

### Alignment Test
```shell
ls -R tekton
```
You should see the `pipelineruns` and `resources` directories under the `tekton` folder.

### Step 2: Export Tekton Manifests. Save the working PipelineRun YAML into the repo.
create this file
```bash
cat > tekton/pipelineruns/backend-test.pipelinerun.yaml <<'YAML'
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  generateName: bill-tracker-backend-test-
spec:
  pipelineSpec:
    workspaces:
      - name: shared-workspace

    params:
      - name: git-url
        type: string
        default: https://github.com/MrSankofa/bill-tracker-ford-based.git
      - name: git-revision
        type: string
        default: main
      - name: exclude-tags
        type: string
        default: testcontainers
      - name: spring-profile
        type: string
        default: test

    tasks:
      - name: clone
        taskRef:
          name: git-clone
        workspaces:
          - name: output
            workspace: shared-workspace
        params:
          - name: url
            value: $(params.git-url)
          - name: revision
            value: $(params.git-revision)
          - name: deleteExisting
            value: "true"

      - name: gradle-test
        runAfter: ["clone"]
        workspaces:
          - name: source
            workspace: shared-workspace
        taskSpec:
          params:
            - name: exclude-tags
              type: string
            - name: spring-profile
              type: string
          workspaces:
            - name: source
          steps:
            - name: test
              image: eclipse-temurin:21-jdk
              workingDir: $(workspaces.source.path)/backend
              script: |
                #!/usr/bin/env bash
                set -euo pipefail
                chmod +x ./gradlew
                ./gradlew clean test \
                  -Dspring.profiles.active=$(params.spring-profile) \
                  -PexcludeTags=$(params.exclude-tags)
        params:
          - name: exclude-tags
            value: $(params.exclude-tags)
          - name: spring-profile
            value: $(params.spring-profile)

  params:
    - name: git-url
      value: https://github.com/MrSankofa/bill-tracker-ford-based.git
    - name: git-revision
      value: main
    - name: exclude-tags
      value: testcontainers
    - name: spring-profile
      value: test

  workspaces:
    - name: shared-workspace
      persistentVolumeClaim:
        claimName: bill-tracker-workspace-pvc
YAML
```

### Alignment Test
```shell
sed -n '1,120p' tekton/pipelineruns/backend-test.pipelinerun.yaml
```

```shell
grep -n "git-revision" -n tekton/pipelineruns/backend-test.pipelinerun.yaml
```
you should see the line number where `git-revision` is defined;
it defaults to `main`. You can change this to match your desired branch or tag.


### 0.4.1.5.2B Run it for your current branch without editing the YAML

```bash
BRANCH="$(git branch --show-current)"

kubectl create -f - <<YAML
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  generateName: bill-tracker-backend-test-
spec:
  pipelineSpec:
    workspaces:
      - name: shared-workspace
    params:
      - name: git-url
        type: string
      - name: git-revision
        type: string
      - name: exclude-tags
        type: string
      - name: spring-profile
        type: string
    tasks:
      - name: clone
        taskRef:
          name: git-clone
        workspaces:
          - name: output
            workspace: shared-workspace
        params:
          - name: url
            value: \$(params.git-url)
          - name: revision
            value: \$(params.git-revision)
          - name: deleteExisting
            value: "true"
      - name: gradle-test
        runAfter: ["clone"]
        workspaces:
          - name: source
            workspace: shared-workspace
        taskSpec:
          params:
            - name: exclude-tags
              type: string
            - name: spring-profile
              type: string
          workspaces:
            - name: source
          steps:
            - name: test
              image: eclipse-temurin:21-jdk
              workingDir: \$(workspaces.source.path)/backend
              script: |
                #!/usr/bin/env bash
                set -euo pipefail
                chmod +x ./gradlew
                ./gradlew clean test \
                  -Dspring.profiles.active=\$(params.spring-profile) \
                  -PexcludeTags=\$(params.exclude-tags)
        params:
          - name: exclude-tags
            value: \$(params.exclude-tags)
          - name: spring-profile
            value: \$(params.spring-profile)
  params:
    - name: git-url
      value: https://github.com/MrSankofa/bill-tracker-ford-based.git
    - name: git-revision
      value: ${BRANCH}
    - name: exclude-tags
      value: testcontainers
    - name: spring-profile
      value: test
  workspaces:
    - name: shared-workspace
      persistentVolumeClaim:
        claimName: bill-tracker-workspace-pvc
YAML

```

```bash
kubectl get pipelinerun --sort-by=.metadata.creationTimestamp | tail -n 1
```

```shell
kubectl get pipelinerun --sort-by=.metadata.creationTimestamp | tail -n 1 | awk '{print $1}'
```

```bash
kubectl get pipelinerun bill-tracker-backend-test-dhztt -o jsonpath='{.spec.params[?(@.name=="git-revision")].value}{"\n"}'
```


### Alignment Test
after running the above command, you can check the created PipelineRun:
```shell
kubectl get pipelinerun
```

Grab the newest PipelineRun name and then:
```bash
kubectl describe pipelinerun <name> | grep -i revision -n
```

you should see the `git-revision` parameter set to your current branch name. You can also check the logs of the `gradle-test` step to 


## Important Note (So we don't regress )

this assumes you've pushed your current branch to GitHub already. If not, Tekton won't be able to clone it.





confirm it matches what you expect. (Especially the -PexcludeTags=testcontainers line in the gradle-test step)

### Step 3: Save the in-cluster postgres resource manifest into the repo (Resources)

Create:
```bash
cat > tekton/resources/postgres.yaml <<'YAML'
apiVersion: v1
kind: Secret
metadata:
  name: bill-tracker-postgres-secret
type: Opaque
stringData:
  POSTGRES_DB: bill_tracker
  POSTGRES_USER: billtracker
  POSTGRES_PASSWORD: billtracker
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bill-tracker-postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bill-tracker-postgres
  template:
    metadata:
      labels:
        app: bill-tracker-postgres
    spec:
      containers:
        - name: postgres
          image: postgres:16-alpine
          ports:
            - containerPort: 5432
          envFrom:
            - secretRef:
                name: bill-tracker-postgres-secret
---
apiVersion: v1
kind: Service
metadata:
  name: bill-tracker-postgres
spec:
  selector:
    app: bill-tracker-postgres
  ports:
    - name: postgres
      port: 5432
      targetPort: 5432
YAML
```

### Alignment Test
```shell
ls -la tekton/resources
```
You should see the `postgres.yaml` file listed in the `tekton/resources` directory.


### Step 4: Add a tiny "how to run doc" (So Future You doesn't suffer)
Create:
```bash
cat > tekton/README.md <<'MD'
# Tekton (local Kubernetes) notes

## One-time setup
1. Ensure Docker Desktop Kubernetes is enabled.
2. Install Tekton Pipelines into the cluster (tekton-pipelines namespace).
3. Create the workspace PVC used by PipelineRuns (bill-tracker-workspace-pvc).
4. Deploy Postgres used by in-cluster integration tests:
   - kubectl apply -f tekton/resources/postgres.yaml

## Run backend tests in Tekton
1. Update the git revision in:
   - tekton/pipelineruns/backend-test.pipelinerun.yaml
2. Create a PipelineRun:
   - kubectl create -f tekton/pipelineruns/backend-test.pipelinerun.yaml
3. Watch:
   - kubectl get pipelinerun
   - kubectl get pods
4. Logs:
   - kubectl logs <gradle-test-pod> -c step-test

## Testcontainers strategy (Pattern A)
- Testcontainers tests are tagged: @Tag("testcontainers")
- Tekton excludes them using:
  - ./gradlew test -PexcludeTags=testcontainers
- Local + GitHub Actions can run them as needed.
MD
```


### Alignment Test
```shell
sed -n '1,160p' tekton/README.md
```

### Step 5: Commit to your YAML repo
```bash
git add tekton
git commit -m "Tekton: add repo manifests for backend PipelineRun and Postgres"
git push
```

